#!/bin/bash
# ============================================================================
# GenerateProjectFiles.sh - Dystopia MUD Build File Generator
# ============================================================================
# Scans src/ subdirectories and generates:
#   - build/Makefile        (Linux GCC)
#   - build/Makefile.mingw  (Windows MinGW)
#
# Usage: ./GenerateProjectFiles.sh
# ============================================================================

set -e

echo ""
echo "============================================================"
echo " Dystopia MUD - Project File Generator"
echo "============================================================"
echo ""

# Navigate to script directory (project root)
cd "$(dirname "$0")"

# Source subdirectories
SUBDIRS="core classes combat commands world systems db"

# ============================================================================
# Step 1: Create backup of existing files
# ============================================================================
echo "[1/4] Creating backup of existing build files..."

BACKUP_DIR="build/backup/$(date +%Y%m%d-%H%M%S)"
HAS_FILES=0

for file in build/Makefile build/Makefile.mingw; do
    if [ -f "$file" ]; then
        HAS_FILES=1
        break
    fi
done

if [ $HAS_FILES -eq 1 ]; then
    mkdir -p "$BACKUP_DIR"

    [ -f "build/Makefile" ] && cp "build/Makefile" "$BACKUP_DIR/"
    [ -f "build/Makefile.mingw" ] && cp "build/Makefile.mingw" "$BACKUP_DIR/"

    echo "       Backup created: $BACKUP_DIR"
else
    echo "       No existing files to backup"
fi

# Ensure build directory exists
mkdir -p build

# ============================================================================
# Step 2: Scan source directories for .c files
# ============================================================================
echo "[2/4] Scanning source directories..."

# Initialize arrays
declare -A SRC_FILES

for subdir in $SUBDIRS; do
    SRC_FILES[$subdir]=""

    # Scan .c files
    for file in src/$subdir/*.c; do
        if [ -f "$file" ]; then
            filename=$(basename "$file")
            if [ -n "${SRC_FILES[$subdir]}" ]; then
                SRC_FILES[$subdir]="${SRC_FILES[$subdir]} $filename"
            else
                SRC_FILES[$subdir]="$filename"
            fi
        fi
    done
done

# Count total files
TOTAL_C=0
for subdir in $SUBDIRS; do
    count=$(echo ${SRC_FILES[$subdir]} | wc -w)
    TOTAL_C=$((TOTAL_C + count))
done
echo "       Found $TOTAL_C source files"

# ============================================================================
# Step 3: Generate Linux Makefile
# ============================================================================
echo "[3/4] Generating build/Makefile (Linux GCC)..."

cat > build/Makefile << 'MAKEFILE_HEADER'
# Linux/Unix Makefile for Dystopia MUD
# Auto-generated by GenerateProjectFiles.sh
# Run from game/build: make -f Makefile
#
# Parallel compilation: make -j$(nproc) -f Makefile

CC = gcc

# Enable parallel-safe output (GNU Make 4.0+)
MAKEFLAGS += --output-sync=target

# Directories (relative to game/build/)
SRC_DIR = ../src
OBJ_DIR = linux/obj

# Subdirectories
CORE_DIR     = $(SRC_DIR)/core
CLASSES_DIR  = $(SRC_DIR)/classes
COMBAT_DIR   = $(SRC_DIR)/combat
COMMANDS_DIR = $(SRC_DIR)/commands
WORLD_DIR    = $(SRC_DIR)/world
SYSTEMS_DIR  = $(SRC_DIR)/systems
DB_DIR       = $(SRC_DIR)/db

# Include paths (so #include "merc.h" works from any source file)
INCLUDES = -I$(CORE_DIR) -I$(CLASSES_DIR) -I$(WORLD_DIR) -I$(SYSTEMS_DIR) -I$(DB_DIR)

# Compiler and linker flags
C_FLAGS = -Wall -O2 $(INCLUDES)
SQLITE_FLAGS = -w -O2 -DSQLITE_THREADSAFE=0 -DSQLITE_OMIT_LOAD_EXTENSION -DSQLITE_DEFAULT_MEMSTATUS=0 $(INCLUDES)
L_FLAGS = -lz -lcrypt -lpthread -ldl

MAKEFILE_HEADER

# Add source file lists
echo "# Source files by directory" >> build/Makefile
echo "CORE_SRC = ${SRC_FILES[core]}" >> build/Makefile
echo "CLASSES_SRC = ${SRC_FILES[classes]}" >> build/Makefile
echo "COMBAT_SRC = ${SRC_FILES[combat]}" >> build/Makefile
echo "COMMANDS_SRC = ${SRC_FILES[commands]}" >> build/Makefile
echo "WORLD_SRC = ${SRC_FILES[world]}" >> build/Makefile
echo "SYSTEMS_SRC = ${SRC_FILES[systems]}" >> build/Makefile
echo "DB_SRC = ${SRC_FILES[db]}" >> build/Makefile

cat >> build/Makefile << 'MAKEFILE_FOOTER'

# Object files with subdirectory paths
CORE_OBJ     = $(addprefix $(OBJ_DIR)/core/,$(CORE_SRC:.c=.o))
CLASSES_OBJ  = $(addprefix $(OBJ_DIR)/classes/,$(CLASSES_SRC:.c=.o))
COMBAT_OBJ   = $(addprefix $(OBJ_DIR)/combat/,$(COMBAT_SRC:.c=.o))
COMMANDS_OBJ = $(addprefix $(OBJ_DIR)/commands/,$(COMMANDS_SRC:.c=.o))
WORLD_OBJ    = $(addprefix $(OBJ_DIR)/world/,$(WORLD_SRC:.c=.o))
SYSTEMS_OBJ  = $(addprefix $(OBJ_DIR)/systems/,$(SYSTEMS_SRC:.c=.o))
DB_OBJ       = $(addprefix $(OBJ_DIR)/db/,$(DB_SRC:.c=.o))

O_FILES = $(CORE_OBJ) $(CLASSES_OBJ) $(COMBAT_OBJ) $(COMMANDS_OBJ) $(WORLD_OBJ) $(SYSTEMS_OBJ) $(DB_OBJ)

# Object directory structure
OBJ_DIRS = $(OBJ_DIR)/core $(OBJ_DIR)/classes $(OBJ_DIR)/combat \
           $(OBJ_DIR)/commands $(OBJ_DIR)/world $(OBJ_DIR)/systems $(OBJ_DIR)/db

# Target executable (in gamedata/ for deployment)
TARGET = ../../gamedata/dystopia

all: $(OBJ_DIRS) $(TARGET)

# Create all object subdirectories
$(OBJ_DIRS):
	mkdir -p $@

$(TARGET): $(O_FILES)
	$(CC) -o $(TARGET) $(O_FILES) $(L_FLAGS)
	chmod g+w $(TARGET)

# Pattern rules for each source directory
$(OBJ_DIR)/core/%.o: $(CORE_DIR)/%.c $(CORE_DIR)/merc.h
	$(CC) -c $(C_FLAGS) $< -o $@

$(OBJ_DIR)/classes/%.o: $(CLASSES_DIR)/%.c $(CORE_DIR)/merc.h
	$(CC) -c $(C_FLAGS) $< -o $@

$(OBJ_DIR)/combat/%.o: $(COMBAT_DIR)/%.c $(CORE_DIR)/merc.h
	$(CC) -c $(C_FLAGS) $< -o $@

$(OBJ_DIR)/commands/%.o: $(COMMANDS_DIR)/%.c $(CORE_DIR)/merc.h
	$(CC) -c $(C_FLAGS) $< -o $@

$(OBJ_DIR)/world/%.o: $(WORLD_DIR)/%.c $(CORE_DIR)/merc.h $(WORLD_DIR)/olc.h
	$(CC) -c $(C_FLAGS) $< -o $@

$(OBJ_DIR)/systems/%.o: $(SYSTEMS_DIR)/%.c $(CORE_DIR)/merc.h
	$(CC) -c $(C_FLAGS) $< -o $@

# SQLite amalgamation uses special flags (suppress warnings, disable threading)
$(OBJ_DIR)/db/sqlite3.o: $(DB_DIR)/sqlite3.c
	$(CC) -c $(SQLITE_FLAGS) $< -o $@

$(OBJ_DIR)/db/%.o: $(DB_DIR)/%.c $(CORE_DIR)/merc.h $(DB_DIR)/db_sql.h
	$(CC) -c $(C_FLAGS) $< -o $@

clean:
	rm -f $(O_FILES) $(TARGET)
	rm -rf $(OBJ_DIR)

.PHONY: clean all
MAKEFILE_FOOTER

# ============================================================================
# Step 4: Generate MinGW Makefile
# ============================================================================
echo "[4/4] Generating build/Makefile.mingw (Windows MinGW)..."

cat > build/Makefile.mingw << 'MAKEFILE_HEADER'
# MinGW Makefile for Dystopia MUD (Windows)
# Auto-generated by GenerateProjectFiles.sh
# Run from game/build: make -f Makefile.mingw
#
# For easier builds, use: build.bat

CC = gcc

# Enable parallel-safe output (GNU Make 4.0+)
MAKEFLAGS += --output-sync=target

# Directories (relative to game/build/)
SRC_DIR = ../src
OBJ_DIR = win64/obj

# Subdirectories
CORE_DIR     = $(SRC_DIR)/core
CLASSES_DIR  = $(SRC_DIR)/classes
COMBAT_DIR   = $(SRC_DIR)/combat
COMMANDS_DIR = $(SRC_DIR)/commands
WORLD_DIR    = $(SRC_DIR)/world
SYSTEMS_DIR  = $(SRC_DIR)/systems
DB_DIR       = $(SRC_DIR)/db

# Include paths
INCLUDES = -I$(CORE_DIR) -I$(CLASSES_DIR) -I$(WORLD_DIR) -I$(SYSTEMS_DIR) -I$(DB_DIR)

# Compiler and linker flags for Windows
C_FLAGS = -Wall -DWIN32 -DHAVE_ZLIB -O2 -c $(INCLUDES)
SQLITE_FLAGS = -w -DWIN32 -DHAVE_ZLIB -O2 -c -DSQLITE_THREADSAFE=0 -DSQLITE_OMIT_LOAD_EXTENSION -DSQLITE_DEFAULT_MEMSTATUS=0 $(INCLUDES)
L_FLAGS = -lws2_32 -lbcrypt -lz

MAKEFILE_HEADER

# Add source file lists
echo "# Source files by directory" >> build/Makefile.mingw
echo "CORE_SRC = ${SRC_FILES[core]}" >> build/Makefile.mingw
echo "CLASSES_SRC = ${SRC_FILES[classes]}" >> build/Makefile.mingw
echo "COMBAT_SRC = ${SRC_FILES[combat]}" >> build/Makefile.mingw
echo "COMMANDS_SRC = ${SRC_FILES[commands]}" >> build/Makefile.mingw
echo "WORLD_SRC = ${SRC_FILES[world]}" >> build/Makefile.mingw
echo "SYSTEMS_SRC = ${SRC_FILES[systems]}" >> build/Makefile.mingw
echo "DB_SRC = ${SRC_FILES[db]}" >> build/Makefile.mingw

cat >> build/Makefile.mingw << 'MAKEFILE_FOOTER'

# Object files with subdirectory paths
CORE_OBJ     = $(addprefix $(OBJ_DIR)/core/,$(CORE_SRC:.c=.o))
CLASSES_OBJ  = $(addprefix $(OBJ_DIR)/classes/,$(CLASSES_SRC:.c=.o))
COMBAT_OBJ   = $(addprefix $(OBJ_DIR)/combat/,$(COMBAT_SRC:.c=.o))
COMMANDS_OBJ = $(addprefix $(OBJ_DIR)/commands/,$(COMMANDS_SRC:.c=.o))
WORLD_OBJ    = $(addprefix $(OBJ_DIR)/world/,$(WORLD_SRC:.c=.o))
SYSTEMS_OBJ  = $(addprefix $(OBJ_DIR)/systems/,$(SYSTEMS_SRC:.c=.o))
DB_OBJ       = $(addprefix $(OBJ_DIR)/db/,$(DB_SRC:.c=.o))

O_FILES = $(CORE_OBJ) $(CLASSES_OBJ) $(COMBAT_OBJ) $(COMMANDS_OBJ) $(WORLD_OBJ) $(SYSTEMS_OBJ) $(DB_OBJ)

# Object directory structure
OBJ_DIRS = $(OBJ_DIR)/core $(OBJ_DIR)/classes $(OBJ_DIR)/combat \
           $(OBJ_DIR)/commands $(OBJ_DIR)/world $(OBJ_DIR)/systems $(OBJ_DIR)/db

# Target executable selection (in gamedata/ for deployment):
# - If dystopia.exe doesn't exist, build dystopia.exe (fresh install)
# - If dystopia.exe exists, build dystopia_new.exe (hot-reload update)
BIN_DIR = ../../gamedata
ifeq ($(wildcard $(BIN_DIR)/dystopia.exe),)
  TARGET = $(BIN_DIR)/dystopia.exe
else
  TARGET = $(BIN_DIR)/dystopia_new.exe
endif

all: $(OBJ_DIRS) $(TARGET)

# Runtime DLL location (copy to gamedata/)
ZLIB_DLL = ../lib/win64/bin/zlib1.dll

# Explicit targets for when you want to force a specific output
$(BIN_DIR)/dystopia.exe: $(OBJ_DIRS) $(O_FILES)
	$(CC) -o $(BIN_DIR)/dystopia.exe $(O_FILES) $(L_FLAGS)
	cp -n $(ZLIB_DLL) $(BIN_DIR)/ 2>/dev/null || true

$(BIN_DIR)/dystopia_new.exe: $(OBJ_DIRS) $(O_FILES)
	$(CC) -o $(BIN_DIR)/dystopia_new.exe $(O_FILES) $(L_FLAGS)
	cp -n $(ZLIB_DLL) $(BIN_DIR)/ 2>/dev/null || true

# Create all object subdirectories
$(OBJ_DIRS):
	mkdir -p $@

# Pattern rules for each source directory
$(OBJ_DIR)/core/%.o: $(CORE_DIR)/%.c $(CORE_DIR)/merc.h
	$(CC) $(C_FLAGS) $< -o $@

$(OBJ_DIR)/classes/%.o: $(CLASSES_DIR)/%.c $(CORE_DIR)/merc.h
	$(CC) $(C_FLAGS) $< -o $@

$(OBJ_DIR)/combat/%.o: $(COMBAT_DIR)/%.c $(CORE_DIR)/merc.h
	$(CC) $(C_FLAGS) $< -o $@

$(OBJ_DIR)/commands/%.o: $(COMMANDS_DIR)/%.c $(CORE_DIR)/merc.h
	$(CC) $(C_FLAGS) $< -o $@

$(OBJ_DIR)/world/%.o: $(WORLD_DIR)/%.c $(CORE_DIR)/merc.h $(WORLD_DIR)/olc.h
	$(CC) $(C_FLAGS) $< -o $@

$(OBJ_DIR)/systems/%.o: $(SYSTEMS_DIR)/%.c $(CORE_DIR)/merc.h
	$(CC) $(C_FLAGS) $< -o $@

# SQLite amalgamation uses special flags (suppress warnings, disable threading)
$(OBJ_DIR)/db/sqlite3.o: $(DB_DIR)/sqlite3.c
	$(CC) $(SQLITE_FLAGS) $< -o $@

$(OBJ_DIR)/db/%.o: $(DB_DIR)/%.c $(CORE_DIR)/merc.h $(DB_DIR)/db_sql.h
	$(CC) $(C_FLAGS) $< -o $@

clean:
	rm -f $(O_FILES) $(BIN_DIR)/dystopia.exe $(BIN_DIR)/dystopia_new.exe
	rm -rf $(OBJ_DIR)

.PHONY: clean all
MAKEFILE_FOOTER

# ============================================================================
# Complete
# ============================================================================
echo ""
echo "============================================================"
echo " Generation Complete!"
echo "============================================================"
echo ""
echo "Generated files:"
echo "  - build/Makefile        (Linux GCC)"
echo "  - build/Makefile.mingw  (Windows MinGW)"
echo ""
if [ $HAS_FILES -eq 1 ]; then
    echo "Backup location: $BACKUP_DIR"
    echo ""
fi
echo "To build (run from game/build/):"
echo "  Linux:  make -f Makefile"
echo "  MinGW:  make -f Makefile.mingw"
echo ""
echo "Note: For Visual Studio files, run GenerateProjectFiles.bat on Windows"
echo ""
