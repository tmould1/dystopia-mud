<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dystopia MUD - Area Analysis</title>
    <link rel="stylesheet" href="css/map.css">
    <style>
        .analysis-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1rem;
            padding: 1rem;
            height: calc(100vh - 120px);
            overflow: hidden;
        }

        .area-list {
            background: #16213e;
            border-radius: 8px;
            padding: 1rem;
            overflow-y: auto;
        }

        .area-list h2 {
            font-size: 1.1rem;
            color: #4a90d9;
            margin-bottom: 1rem;
            border-bottom: 1px solid #0f3460;
            padding-bottom: 0.5rem;
        }

        .area-item {
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .area-item:hover {
            background: #0f3460;
        }

        .area-item.active {
            background: #4a90d9;
        }

        .area-item .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .area-item .stats {
            font-size: 0.8rem;
            color: #888;
        }

        .analysis-content {
            background: #16213e;
            border-radius: 8px;
            padding: 1rem;
            overflow-y: auto;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #0f3460;
            padding-bottom: 0.5rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            background: transparent;
            color: #aaa;
            border: none;
            font-size: 1rem;
        }

        .tab:hover {
            background: #0f3460;
            color: #fff;
        }

        .tab.active {
            background: #4a90d9;
            color: #fff;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .summary-card {
            background: #0d1117;
            border-radius: 8px;
            padding: 1rem;
        }

        .summary-card h3 {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 0.5rem;
        }

        .summary-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4a90d9;
        }

        .summary-card .sub {
            font-size: 0.8rem;
            color: #666;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th {
            text-align: left;
            padding: 0.5rem;
            background: #0d1117;
            color: #4a90d9;
            border-bottom: 2px solid #0f3460;
            cursor: pointer;
        }

        .data-table th:hover {
            background: #0f3460;
        }

        .data-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #0f3460;
        }

        .data-table tr:hover {
            background: #0f3460;
        }

        .tier-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .tier-trivial { background: #2d4a3e; color: #7ed3a4; }
        .tier-easy { background: #3d4a2d; color: #a4d37e; }
        .tier-normal { background: #4a4a2d; color: #d3d37e; }
        .tier-hard { background: #4a3a2d; color: #d3a47e; }
        .tier-deadly { background: #4a2d2d; color: #d37e7e; }

        .tier-junk { background: #3d3d3d; color: #888; }
        .tier-common { background: #2d4a3e; color: #7ed3a4; }
        .tier-uncommon { background: #2d4a4a; color: #7ed3d3; }
        .tier-rare { background: #2d3d4a; color: #7ea4d3; }
        .tier-epic { background: #3d2d4a; color: #a47ed3; }
        .tier-legendary { background: #4a3d2d; color: #d3a47e; }

        .distribution-bar {
            display: flex;
            height: 24px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .distribution-bar .segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: white;
            min-width: 20px;
        }

        .search-box {
            margin-bottom: 1rem;
        }

        .search-box input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #0f3460;
            border-radius: 4px;
            background: #0d1117;
            color: #eee;
        }

        .search-box input:focus {
            outline: none;
            border-color: #4a90d9;
        }

        .sort-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }

        .sort-controls label {
            font-size: 0.85rem;
            color: #888;
        }

        .sort-controls select {
            flex: 1;
            padding: 0.4rem;
            border: 1px solid #0f3460;
            border-radius: 4px;
            background: #0d1117;
            color: #eee;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .sort-controls select:focus {
            outline: none;
            border-color: #4a90d9;
        }

        /* Area filter for global rankings */
        .area-filter {
            margin-bottom: 1rem;
            background: #0d1117;
            border-radius: 8px;
            padding: 1rem;
        }

        .area-filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .area-filter-header h3 {
            margin: 0;
            font-size: 0.95rem;
            color: #4a90d9;
        }

        .area-filter-actions {
            display: flex;
            gap: 0.5rem;
        }

        .area-filter-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border: 1px solid #0f3460;
            border-radius: 4px;
            background: #16213e;
            color: #aaa;
            cursor: pointer;
        }

        .area-filter-actions button:hover {
            background: #0f3460;
            color: #fff;
        }

        .area-filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.25rem;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .area-filter-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .area-filter-item:hover {
            background: #0f3460;
        }

        .area-filter-item input {
            cursor: pointer;
        }

        .area-filter-item label {
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .area-filter-item.excluded {
            opacity: 0.5;
        }

        .area-filter-item.excluded label {
            text-decoration: line-through;
        }

        .filter-count {
            font-size: 0.8rem;
            color: #888;
            margin-left: 0.5rem;
        }

        /* Query tab styles */
        .query-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .query-type-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .query-type-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #0f3460;
            border-radius: 4px;
            background: #0d1117;
            color: #aaa;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .query-type-btn:hover {
            background: #16213e;
            color: #fff;
        }

        .query-type-btn.active {
            background: #4a90d9;
            color: #fff;
            border-color: #4a90d9;
        }

        .filter-builder {
            background: #0d1117;
            border-radius: 8px;
            padding: 1rem;
        }

        .filter-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .filter-row select, .filter-row input {
            padding: 0.4rem 0.5rem;
            border: 1px solid #0f3460;
            border-radius: 4px;
            background: #16213e;
            color: #eee;
            font-size: 0.85rem;
        }

        .filter-row select:focus, .filter-row input:focus {
            outline: none;
            border-color: #4a90d9;
        }

        .filter-field { width: 150px; }
        .filter-operator { width: 120px; }
        .filter-value { flex: 1; min-width: 150px; }

        .filter-remove {
            background: #4a2d2d;
            color: #d37e7e;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filter-remove:hover {
            background: #5a3d3d;
        }

        .filter-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .filter-actions button {
            padding: 0.4rem 0.75rem;
            border: 1px solid #0f3460;
            border-radius: 4px;
            background: #16213e;
            color: #aaa;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .filter-actions button:hover {
            background: #0f3460;
            color: #fff;
        }

        .filter-actions .run-query {
            background: #4a90d9;
            border-color: #4a90d9;
            color: #fff;
        }

        .filter-actions .run-query:hover {
            background: #5a9fe9;
        }

        .query-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .query-results-count {
            font-size: 0.95rem;
            color: #7ed3a4;
        }

        .preset-queries {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .preset-btn {
            padding: 0.3rem 0.6rem;
            border: 1px solid #0f3460;
            border-radius: 12px;
            background: #16213e;
            color: #aaa;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .preset-btn:hover {
            background: #0f3460;
            color: #4a90d9;
            border-color: #4a90d9;
        }

        .area-filter-toggle {
            padding: 0.4rem 0.75rem;
            border: 1px solid #0f3460;
            border-radius: 4px;
            background: #0d1117;
            color: #aaa;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .area-filter-toggle:hover {
            background: #16213e;
        }

        .area-filter-toggle.active {
            border-color: #4a90d9;
            color: #4a90d9;
        }

        .query-area-filter {
            margin-top: 0.5rem;
            display: none;
        }

        .query-area-filter.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <h1>Dystopia MUD Analysis</h1>
            <nav class="nav">
                <a href="index.html">World Overview</a>
                <a href="area.html">Area Detail</a>
                <a href="analysis.html" class="active">Analysis</a>
            </nav>
        </header>

        <div class="analysis-grid">
            <div class="area-list">
                <h2>Areas</h2>
                <div class="search-box">
                    <input type="text" id="area-search" placeholder="Search areas...">
                </div>
                <div class="sort-controls">
                    <label>Sort:</label>
                    <select id="area-sort">
                        <option value="name-asc">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="level-asc">Level (Low-High)</option>
                        <option value="level-desc">Level (High-Low)</option>
                        <option value="difficulty-asc">Difficulty (Low-High)</option>
                        <option value="difficulty-desc">Difficulty (High-Low)</option>
                        <option value="mobs-desc">Most Mobs</option>
                        <option value="rooms-desc">Most Rooms</option>
                    </select>
                </div>
                <div id="area-list-items">
                    <p>Loading areas...</p>
                </div>
            </div>

            <div class="analysis-content">
                <div class="tabs">
                    <button class="tab active" data-tab="summary">Summary</button>
                    <button class="tab" data-tab="mobs">Mobs</button>
                    <button class="tab" data-tab="objects">Objects</button>
                    <button class="tab" data-tab="spawns">Spawns</button>
                    <button class="tab" data-tab="rankings">Global Rankings</button>
                    <button class="tab" data-tab="query">Query</button>
                </div>

                <div id="tab-content">
                    <p>Select an area to view analysis.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let analysisData = null;
        let mobRankings = null;
        let objectRankings = null;
        let currentArea = null;
        let currentTab = 'summary';
        let currentSort = 'name-asc';
        let selectedAreas = new Set(); // Areas included in global rankings (empty = all)

        async function init() {
            const listItems = document.getElementById('area-list-items');
            try {
                listItems.innerHTML = '<p>Fetching data...</p>';

                const analysisRes = await fetch('data/analysis.json');
                if (!analysisRes.ok) throw new Error(`analysis.json: ${analysisRes.status}`);
                listItems.innerHTML = '<p>Parsing analysis.json...</p>';
                analysisData = await analysisRes.json();

                const mobRes = await fetch('data/mob_rankings.json');
                if (!mobRes.ok) throw new Error(`mob_rankings.json: ${mobRes.status}`);
                listItems.innerHTML = '<p>Parsing mob_rankings.json...</p>';
                mobRankings = await mobRes.json();

                const objRes = await fetch('data/object_rankings.json');
                if (!objRes.ok) throw new Error(`object_rankings.json: ${objRes.status}`);
                listItems.innerHTML = '<p>Parsing object_rankings.json...</p>';
                objectRankings = await objRes.json();

                listItems.innerHTML = '<p>Rendering...</p>';
                renderAreaList();
                setupEventListeners();

                // Check URL for area parameter
                const params = new URLSearchParams(window.location.search);
                const areaId = params.get('area');
                if (areaId && analysisData[areaId]) {
                    selectArea(areaId);
                }
            } catch (error) {
                console.error('Failed to load data:', error);
                listItems.innerHTML =
                    `<p style="color: #ff4444;">Failed to load: ${error.message}</p>`;
                document.getElementById('tab-content').innerHTML =
                    '<p style="color: #ff4444;">Failed to load analysis data.</p>';
            }
        }

        function renderAreaList() {
            const container = document.getElementById('area-list-items');
            let areas = Object.entries(analysisData);

            // Apply sorting
            const [sortField, sortDir] = currentSort.split('-');
            areas.sort((a, b) => {
                let valA, valB;
                switch (sortField) {
                    case 'name':
                        valA = a[1].summary.name.toLowerCase();
                        valB = b[1].summary.name.toLowerCase();
                        return sortDir === 'asc'
                            ? valA.localeCompare(valB)
                            : valB.localeCompare(valA);
                    case 'level':
                        valA = a[1].summary.avg_mob_level || 0;
                        valB = b[1].summary.avg_mob_level || 0;
                        break;
                    case 'difficulty':
                        valA = a[1].summary.avg_difficulty || 0;
                        valB = b[1].summary.avg_difficulty || 0;
                        break;
                    case 'mobs':
                        valA = a[1].summary.mob_count || 0;
                        valB = b[1].summary.mob_count || 0;
                        break;
                    case 'rooms':
                        valA = a[1].summary.room_count || 0;
                        valB = b[1].summary.room_count || 0;
                        break;
                    default:
                        return 0;
                }
                return sortDir === 'asc' ? valA - valB : valB - valA;
            });

            // Apply search filter
            const searchQuery = document.getElementById('area-search').value.toLowerCase();

            container.innerHTML = areas.map(([id, data]) => {
                const name = data.summary.name;
                const hidden = searchQuery && !name.toLowerCase().includes(searchQuery);
                return `
                    <div class="area-item${currentArea === id ? ' active' : ''}"
                         data-area="${id}"
                         style="${hidden ? 'display:none' : ''}">
                        <span class="name">${name}</span>
                        <span class="stats">L${Math.round(data.summary.avg_mob_level || 0)}</span>
                    </div>
                `;
            }).join('');
        }

        function setupEventListeners() {
            // Area selection
            document.getElementById('area-list-items').addEventListener('click', (e) => {
                const item = e.target.closest('.area-item');
                if (item) {
                    selectArea(item.dataset.area);
                }
            });

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = tab.dataset.tab;
                    renderContent();
                });
            });

            // Area search
            document.getElementById('area-search').addEventListener('input', () => {
                renderAreaList();
            });

            // Area sort
            document.getElementById('area-sort').addEventListener('change', (e) => {
                currentSort = e.target.value;
                renderAreaList();
            });
        }

        function selectArea(areaId) {
            currentArea = areaId;

            // Update active state
            document.querySelectorAll('.area-item').forEach(item => {
                item.classList.toggle('active', item.dataset.area === areaId);
            });

            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('area', areaId);
            window.history.replaceState({}, '', url);

            renderContent();
        }

        function renderContent() {
            const content = document.getElementById('tab-content');

            if (currentTab === 'rankings') {
                renderGlobalRankings(content);
                return;
            }

            if (currentTab === 'query') {
                renderQuery(content);
                return;
            }

            if (!currentArea || !analysisData[currentArea]) {
                content.innerHTML = '<p>Select an area to view analysis.</p>';
                return;
            }

            const data = analysisData[currentArea];

            switch (currentTab) {
                case 'summary':
                    renderSummary(content, data);
                    break;
                case 'mobs':
                    renderMobs(content, data);
                    break;
                case 'objects':
                    renderObjects(content, data);
                    break;
                case 'spawns':
                    renderSpawns(content, data);
                    break;
            }
        }

        function renderSummary(container, data) {
            const s = data.summary;
            const diffDist = s.difficulty_distribution;
            const powerDist = s.power_distribution;

            container.innerHTML = `
                <h2>${s.name}</h2>

                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>Rooms</h3>
                        <div class="value">${s.room_count}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Mobs</h3>
                        <div class="value">${s.mob_count}</div>
                        <div class="sub">Avg Level: ${s.avg_mob_level.toFixed(1)}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Objects</h3>
                        <div class="value">${s.object_count}</div>
                        <div class="sub">Avg Power: ${s.avg_object_power.toFixed(1)}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Avg Difficulty</h3>
                        <div class="value">${s.avg_difficulty.toFixed(0)}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Gold per Reset</h3>
                        <div class="value">${s.total_gold_per_reset.toLocaleString()}</div>
                    </div>
                </div>

                <h3>Mob Difficulty Distribution</h3>
                <div class="distribution-bar">
                    ${renderDistributionBar(diffDist, ['trivial', 'easy', 'normal', 'hard', 'deadly'])}
                </div>

                <h3 style="margin-top: 1rem;">Object Power Distribution</h3>
                <div class="distribution-bar">
                    ${renderDistributionBar(powerDist, ['junk', 'common', 'uncommon', 'rare', 'epic', 'legendary'])}
                </div>

                ${s.shops.length > 0 ? `
                    <h3 style="margin-top: 1rem;">Shops (${s.shops.length})</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Keeper</th>
                                <th>Buys</th>
                                <th>Buy %</th>
                                <th>Sell %</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${s.shops.map(shop => `
                                <tr>
                                    <td>${shop.keeper_name}</td>
                                    <td>${shop.buy_types.join(', ') || 'None'}</td>
                                    <td>${shop.profit_buy}%</td>
                                    <td>${shop.profit_sell}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : ''}
            `;
        }

        function renderDistributionBar(dist, order) {
            const total = order.reduce((sum, key) => sum + (dist[key] || 0), 0);
            if (total === 0) return '<span style="color: #666;">No data</span>';

            const colors = {
                trivial: '#2d4a3e', easy: '#3d4a2d', normal: '#4a4a2d', hard: '#4a3a2d', deadly: '#4a2d2d',
                junk: '#3d3d3d', common: '#2d4a3e', uncommon: '#2d4a4a', rare: '#2d3d4a', epic: '#3d2d4a', legendary: '#4a3d2d'
            };

            return order.map(key => {
                const count = dist[key] || 0;
                if (count === 0) return '';
                const pct = (count / total * 100).toFixed(0);
                return `<div class="segment" style="width: ${pct}%; background: ${colors[key]};">${count}</div>`;
            }).join('');
        }

        function renderMobs(container, data) {
            const mobs = Object.values(data.mobs)
                .sort((a, b) => b.difficulty_score - a.difficulty_score);

            container.innerHTML = `
                <h2>Mobs in ${data.summary.name}</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>VNUM</th>
                            <th>Name</th>
                            <th>Level</th>
                            <th>Difficulty</th>
                            <th>HP</th>
                            <th>Damage</th>
                            <th>AC</th>
                            <th>Hit</th>
                            <th>Flags</th>
                            <th>Spawns</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${mobs.map(mob => `
                            <tr>
                                <td>${mob.vnum}</td>
                                <td>${mob.name}${formatMobBadges(mob)}</td>
                                <td>${mob.level}</td>
                                <td>
                                    <span class="tier-badge tier-${mob.difficulty_tier}">
                                        ${mob.difficulty_tier}
                                    </span>
                                    ${mob.difficulty_score.toFixed(0)}
                                </td>
                                <td>${mob.avg_hp.toLocaleString()}</td>
                                <td>${mob.avg_damage}</td>
                                <td>${mob.ac}</td>
                                <td>${mob.hitroll}</td>
                                <td>${formatMobFlags(mob)}</td>
                                <td>${mob.spawn_count}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function formatMobBadges(mob) {
            let badges = '';
            if (mob.is_mount) badges += ' <span style="color:#7ed3d3;font-size:0.75rem">üê¥</span>';
            if (mob.has_sanctuary) badges += ' <span style="color:#d3d37e;font-size:0.75rem">üõ°Ô∏è</span>';
            if (mob.is_aggressive) badges += ' <span style="color:#d37e7e;font-size:0.75rem">‚öîÔ∏è</span>';
            if (mob.gives_no_exp) badges += ' <span style="color:#888;font-size:0.75rem">‚àÖ</span>';
            return badges;
        }

        function formatMobFlags(mob) {
            const flags = [];
            // Show significant act flags
            const significantAct = ['aggressive', 'sanctuary', 'mount', 'noexp', 'pet', 'sentinel'];
            (mob.act_flags || []).forEach(f => {
                if (significantAct.includes(f)) flags.push(f);
            });
            // Show all aff flags as they're combat relevant
            (mob.aff_flags || []).forEach(f => {
                flags.push(`<span style="color:#a47ed3">${f}</span>`);
            });
            return flags.length > 0 ? flags.join(', ') : '-';
        }

        function renderObjects(container, data) {
            const objects = Object.values(data.objects)
                .sort((a, b) => b.power_score - a.power_score);

            container.innerHTML = `
                <h2>Objects in ${data.summary.name}</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>VNUM</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Power</th>
                            <th>Details</th>
                            <th>Stats</th>
                            <th>Wear</th>
                            <th>Spawns</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${objects.map(obj => `
                            <tr>
                                <td>${obj.vnum}</td>
                                <td>${obj.name}</td>
                                <td>${obj.item_type}</td>
                                <td>
                                    <span class="tier-badge tier-${obj.power_tier}">
                                        ${obj.power_tier}
                                    </span>
                                    ${obj.power_score.toFixed(0)}
                                </td>
                                <td>${formatItemDetails(obj)}</td>
                                <td>${formatStats(obj.stats_summary)}</td>
                                <td>${obj.wear_location || '-'}</td>
                                <td>${obj.spawn_count}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function formatItemDetails(obj) {
            if (obj.weapon) {
                const w = obj.weapon;
                let details = `${w.damage_min}-${w.damage_max} ${w.weapon_type}`;
                if (w.spell) {
                    details += ` <span style="color:#d97e7e">‚öî${w.spell}</span>`;
                }
                if (w.affect) {
                    details += ` <span style="color:#a47ed3">‚ú®${w.affect}</span>`;
                }
                return details;
            }
            if (obj.armor) {
                const a = obj.armor;
                let details = `AC ${a.ac}`;
                if (a.special) details += ` <span style="color:#7ed3d3">${a.special}</span>`;
                return details;
            }
            return '-';
        }

        function formatWeaponType(obj) {
            if (!obj.weapon) return '-';
            const w = obj.weapon;
            let result = w.weapon_type || 'unknown';
            if (w.spell) {
                result += ` <span style="color:#d97e7e" title="On-hit: ${w.spell}">‚öî</span>`;
            }
            if (w.affect) {
                result += ` <span style="color:#a47ed3" title="Wielder: ${w.affect}">‚ú®</span>`;
            }
            return result;
        }

        function renderSpawns(container, data) {
            const spawns = data.spawns || {};
            const mobSpawns = spawns.mob_spawns || [];
            const objSpawns = spawns.obj_spawns || [];
            const crossMobs = spawns.cross_area_mobs || [];
            const crossObjs = spawns.cross_area_objs || [];

            const hasCrossArea = crossMobs.length > 0 || crossObjs.length > 0;

            container.innerHTML = `
                <h2>Spawns in ${data.summary.name}</h2>

                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>Mob Resets</h3>
                        <div class="value">${spawns.total_mob_resets || 0}</div>
                        ${crossMobs.length > 0 ? `<div class="sub" style="color:#d3a47e">${crossMobs.length} from other areas</div>` : ''}
                    </div>
                    <div class="summary-card">
                        <h3>Object Resets</h3>
                        <div class="value">${spawns.total_obj_resets || 0}</div>
                        ${crossObjs.length > 0 ? `<div class="sub" style="color:#d3a47e">${crossObjs.length} from other areas</div>` : ''}
                    </div>
                </div>

                ${hasCrossArea ? `
                    <h3 style="margin-top: 1rem; color: #d3a47e;">‚ö† Cross-Area Spawns</h3>
                    <p style="color: #888; font-size: 0.9rem; margin-bottom: 1rem;">
                        These mobs/objects are defined in other areas but spawn here.
                    </p>

                    ${crossMobs.length > 0 ? `
                        <h4>Cross-Area Mobs (${crossMobs.length})</h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>VNUM</th>
                                    <th>Name</th>
                                    <th>Level</th>
                                    <th>Source Area</th>
                                    <th>Spawns In</th>
                                    <th>Max</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${crossMobs.map(mob => `
                                    <tr>
                                        <td>${mob.vnum}</td>
                                        <td>${mob.name}</td>
                                        <td>${mob.level}</td>
                                        <td><a href="analysis.html?area=${mob.source_area}">${mob.source_area}</a></td>
                                        <td>${mob.room_name} (#${mob.room_vnum})</td>
                                        <td>${mob.max_count}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}

                    ${crossObjs.length > 0 ? `
                        <h4 style="margin-top: 1rem;">Cross-Area Objects (${crossObjs.length})</h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>VNUM</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Source Area</th>
                                    <th>Location</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${crossObjs.map(obj => `
                                    <tr>
                                        <td>${obj.vnum}</td>
                                        <td>${obj.name}</td>
                                        <td>${obj.type}</td>
                                        <td><a href="analysis.html?area=${obj.source_area}">${obj.source_area}</a></td>
                                        <td>${formatSpawnLocation(obj)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}
                ` : '<p style="color: #7ed3a4; margin-top: 1rem;">‚úì All spawns in this area use locally-defined mobs and objects.</p>'}

                <h3 style="margin-top: 2rem;">All Mob Spawns (${mobSpawns.length})</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>VNUM</th>
                            <th>Name</th>
                            <th>Level</th>
                            <th>Room</th>
                            <th>Max</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${mobSpawns.map(mob => `
                            <tr style="${mob.is_cross_area ? 'background: #4a3d2d20;' : ''}">
                                <td>${mob.vnum}</td>
                                <td>${mob.name}</td>
                                <td>${mob.level}</td>
                                <td>${mob.room_name} (#${mob.room_vnum})</td>
                                <td>${mob.max_count}</td>
                                <td>${mob.is_cross_area
                                    ? `<a href="analysis.html?area=${mob.source_area}" style="color:#d3a47e">${mob.source_area}</a>`
                                    : '<span style="color:#7ed3a4">local</span>'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <h3 style="margin-top: 2rem;">All Object Spawns (${objSpawns.length})</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>VNUM</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${objSpawns.map(obj => `
                            <tr style="${obj.is_cross_area ? 'background: #4a3d2d20;' : ''}">
                                <td>${obj.vnum}</td>
                                <td>${obj.name}</td>
                                <td>${obj.type}</td>
                                <td>${formatSpawnLocation(obj)}</td>
                                <td>${obj.is_cross_area
                                    ? `<a href="analysis.html?area=${obj.source_area}" style="color:#d3a47e">${obj.source_area}</a>`
                                    : '<span style="color:#7ed3a4">local</span>'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function formatSpawnLocation(obj) {
            switch (obj.type) {
                case 'object_room':
                    return `${obj.room_name} (#${obj.room_vnum})`;
                case 'object_inventory':
                    return `inventory of ${obj.mob_name}`;
                case 'object_equipped':
                    return `${obj.wear_loc} on ${obj.mob_name}`;
                case 'object_container':
                    return `in ${obj.container_name}`;
                default:
                    return '-';
            }
        }

        function renderGlobalRankings(container) {
            // Get all area IDs sorted by name
            const allAreaIds = Object.keys(analysisData).sort((a, b) => {
                const nameA = analysisData[a].summary.name.toLowerCase();
                const nameB = analysisData[b].summary.name.toLowerCase();
                return nameA.localeCompare(nameB);
            });

            // If no areas selected, include all
            const activeFilter = selectedAreas.size > 0;
            const includedAreas = activeFilter ? selectedAreas : new Set(allAreaIds);

            // Filter rankings by selected areas
            const filteredObjects = objectRankings.filter(obj => includedAreas.has(obj.area_id));
            const filteredWeapons = filteredObjects.filter(obj => obj.item_type === 'weapon');
            const filteredArmor = filteredObjects.filter(obj => obj.item_type === 'armor');
            const filteredMobs = mobRankings.filter(mob => includedAreas.has(mob.area_id));

            const filterCountText = activeFilter
                ? `${selectedAreas.size} of ${allAreaIds.length} areas`
                : `All ${allAreaIds.length} areas`;

            container.innerHTML = `
                <h2>Global Rankings</h2>

                <div class="area-filter">
                    <div class="area-filter-header">
                        <h3>Filter by Area <span class="filter-count">(${filterCountText})</span></h3>
                        <div class="area-filter-actions">
                            <button onclick="selectAllAreas()">Select All</button>
                            <button onclick="deselectAllAreas()">Deselect All</button>
                        </div>
                    </div>
                    <div class="area-filter-grid">
                        ${allAreaIds.map(areaId => {
                            const name = analysisData[areaId].summary.name;
                            const isChecked = !activeFilter || selectedAreas.has(areaId);
                            return `
                                <div class="area-filter-item ${isChecked ? '' : 'excluded'}">
                                    <input type="checkbox" id="filter-${areaId}"
                                           ${isChecked ? 'checked' : ''}
                                           onchange="toggleAreaFilter('${areaId}', this.checked)">
                                    <label for="filter-${areaId}" title="${name}">${name}</label>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <h3>Top 50 Weapons</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>VNUM</th>
                            <th>Name</th>
                            <th>Area</th>
                            <th>Power</th>
                            <th>Damage</th>
                            <th>Type</th>
                            <th>Stats</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredWeapons.slice(0, 50).map((obj, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${obj.vnum}</td>
                                <td>${obj.name}</td>
                                <td><a href="analysis.html?area=${obj.area_id}">${obj.area_name}</a></td>
                                <td>
                                    <span class="tier-badge tier-${obj.power_tier}">
                                        ${obj.power_tier}
                                    </span>
                                    ${obj.power_score.toFixed(0)}
                                </td>
                                <td>${obj.weapon ? `${obj.weapon.damage_min}-${obj.weapon.damage_max}` : '-'}</td>
                                <td>${formatWeaponType(obj)}</td>
                                <td>${formatStats(obj.stats_summary)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <h3 style="margin-top: 2rem;">Top 50 Armor</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>VNUM</th>
                            <th>Name</th>
                            <th>Area</th>
                            <th>Power</th>
                            <th>AC</th>
                            <th>Special</th>
                            <th>Wear</th>
                            <th>Stats</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredArmor.slice(0, 50).map((obj, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${obj.vnum}</td>
                                <td>${obj.name}</td>
                                <td><a href="analysis.html?area=${obj.area_id}">${obj.area_name}</a></td>
                                <td>
                                    <span class="tier-badge tier-${obj.power_tier}">
                                        ${obj.power_tier}
                                    </span>
                                    ${obj.power_score.toFixed(0)}
                                </td>
                                <td>${obj.armor ? obj.armor.ac : '-'}</td>
                                <td>${obj.armor && obj.armor.special ? `<span style="color:#7ed3d3">${obj.armor.special}</span>` : '-'}</td>
                                <td>${obj.wear_location || '-'}</td>
                                <td>${formatStats(obj.stats_summary)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <h3 style="margin-top: 2rem;">Top 50 Deadliest Mobs</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>VNUM</th>
                            <th>Name</th>
                            <th>Area</th>
                            <th>Level</th>
                            <th>Difficulty</th>
                            <th>HP</th>
                            <th>Damage</th>
                            <th>AC</th>
                            <th>Flags</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredMobs.slice(0, 50).map((mob, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${mob.vnum}</td>
                                <td>${mob.name}${formatMobBadges(mob)}</td>
                                <td><a href="analysis.html?area=${mob.area_id}">${mob.area_name}</a></td>
                                <td>${mob.level}</td>
                                <td>
                                    <span class="tier-badge tier-${mob.difficulty_tier}">
                                        ${mob.difficulty_tier}
                                    </span>
                                    ${mob.difficulty_score.toFixed(0)}
                                </td>
                                <td>${mob.avg_hp.toLocaleString()}</td>
                                <td>${mob.avg_damage || '-'}</td>
                                <td>${mob.ac || '-'}</td>
                                <td>${formatMobFlags(mob)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function toggleAreaFilter(areaId, isChecked) {
            if (selectedAreas.size === 0) {
                // First time filtering - start with all selected except the unchecked one
                Object.keys(analysisData).forEach(id => {
                    if (id !== areaId || isChecked) {
                        selectedAreas.add(id);
                    }
                });
                if (!isChecked) {
                    selectedAreas.delete(areaId);
                }
            } else {
                if (isChecked) {
                    selectedAreas.add(areaId);
                } else {
                    selectedAreas.delete(areaId);
                }
            }
            renderContent();
        }

        function selectAllAreas() {
            selectedAreas.clear(); // Empty set means all areas
            renderContent();
        }

        function deselectAllAreas() {
            selectedAreas.clear();
            // Add a dummy entry so the filter is "active" but nothing passes
            selectedAreas.add('__none__');
            renderContent();
        }

        function formatStats(stats) {
            if (!stats || Object.keys(stats).length === 0) return '-';
            return Object.entries(stats)
                .map(([key, val]) => `${key}: ${val > 0 ? '+' : ''}${val}`)
                .join(', ');
        }

        // ========== QUERY SYSTEM ==========
        let queryType = 'objects';
        let queryFilters = [];
        let queryResults = [];
        let queryHasRun = false; // Track if a query has been executed
        let queryAreaFilter = new Set(); // Empty = all areas

        const QUERY_FIELDS = {
            objects: [
                { id: 'item_type', label: 'Item Type', type: 'select',
                  options: ['weapon', 'armor', 'container', 'light', 'scroll', 'wand', 'staff', 'treasure', 'potion', 'furniture', 'trash', 'drink', 'key', 'food', 'money', 'boat', 'fountain', 'pill', 'portal', 'quest', 'book', 'tool'] },
                { id: 'weapon.weapon_type', label: 'Weapon Type', type: 'select',
                  options: ['hit', 'slice', 'stab', 'slash', 'whip', 'claw', 'blast', 'pound', 'crush', 'grep', 'bite', 'pierce', 'suck', 'INVALID_NEGATIVE', 'INVALID_HIGH'] },
                { id: 'weapon.weapon_type_id', label: 'Weapon Type ID', type: 'number' },
                { id: 'power_tier', label: 'Power Tier', type: 'select',
                  options: ['junk', 'common', 'uncommon', 'rare', 'epic', 'legendary'] },
                { id: 'can_take', label: 'Can Pick Up', type: 'boolean' },
                { id: 'can_drop', label: 'Can Drop', type: 'boolean' },
                { id: 'wear_location', label: 'Wear Location', type: 'select',
                  options: ['finger', 'neck', 'body', 'head', 'legs', 'feet', 'hands', 'arms', 'shield', 'about', 'waist', 'wrist', 'wield', 'hold', 'face', 'light'] },
                { id: 'name', label: 'Name Contains', type: 'text' },
                { id: 'weight', label: 'Weight', type: 'number' },
                { id: 'cost', label: 'Cost', type: 'number' },
                { id: 'power_score', label: 'Power Score', type: 'number' },
                { id: 'hitroll', label: 'Hitroll', type: 'number' },
                { id: 'damroll', label: 'Damroll', type: 'number' },
                { id: 'spawn_count', label: 'Spawn Count', type: 'number' },
            ],
            mobs: [
                { id: 'alignment', label: 'Alignment', type: 'number' },
                { id: 'level', label: 'Level', type: 'number' },
                { id: 'difficulty_tier', label: 'Difficulty', type: 'select',
                  options: ['trivial', 'easy', 'normal', 'hard', 'deadly'] },
                { id: 'difficulty_score', label: 'Difficulty Score', type: 'number' },
                { id: 'name', label: 'Name Contains', type: 'text' },
                { id: 'is_aggressive', label: 'Is Aggressive', type: 'boolean' },
                { id: 'has_sanctuary', label: 'Has Sanctuary', type: 'boolean' },
                { id: 'is_mount', label: 'Is Mount', type: 'boolean' },
                { id: 'gives_no_exp', label: 'Gives No EXP', type: 'boolean' },
                { id: 'avg_hp', label: 'Avg HP', type: 'number' },
                { id: 'avg_damage', label: 'Avg Damage', type: 'number' },
                { id: 'gold', label: 'Gold', type: 'number' },
                { id: 'spawn_count', label: 'Spawn Count', type: 'number' },
            ]
        };

        const QUERY_OPERATORS = {
            select: [
                { id: 'eq', label: 'equals' },
                { id: 'neq', label: 'not equals' }
            ],
            text: [
                { id: 'contains', label: 'contains' },
                { id: 'eq', label: 'equals' },
                { id: 'starts', label: 'starts with' }
            ],
            number: [
                { id: 'eq', label: '=' },
                { id: 'neq', label: '!=' },
                { id: 'gt', label: '>' },
                { id: 'gte', label: '>=' },
                { id: 'lt', label: '<' },
                { id: 'lte', label: '<=' }
            ],
            boolean: [
                { id: 'eq', label: 'is' }
            ]
        };

        const PRESET_QUERIES = {
            objects: [
                { label: 'Player Bags', filters: [
                    { field: 'item_type', operator: 'eq', value: 'container' },
                    { field: 'can_take', operator: 'eq', value: 'true' }
                ]},
                { label: 'Legendary Items', filters: [
                    { field: 'power_tier', operator: 'eq', value: 'legendary' }
                ]},
                { label: 'Spell Weapons', filters: [
                    { field: 'item_type', operator: 'eq', value: 'weapon' }
                ]},
                { label: 'High Hitroll', filters: [
                    { field: 'hitroll', operator: 'gte', value: '50' }
                ]},
                { label: 'Invalid Wpn Type (>12)', filters: [
                    { field: 'weapon.weapon_type_id', operator: 'gt', value: '12' }
                ]},
                { label: 'Invalid Wpn Type (<0)', filters: [
                    { field: 'weapon.weapon_type_id', operator: 'lt', value: '0' }
                ]},
            ],
            mobs: [
                { label: 'Good Mobs', filters: [
                    { field: 'alignment', operator: 'gt', value: '350' }
                ]},
                { label: 'Evil Mobs', filters: [
                    { field: 'alignment', operator: 'lt', value: '-350' }
                ]},
                { label: 'Sanctuary Mobs', filters: [
                    { field: 'has_sanctuary', operator: 'eq', value: 'true' }
                ]},
                { label: 'Aggressive Mobs', filters: [
                    { field: 'is_aggressive', operator: 'eq', value: 'true' }
                ]},
                { label: 'Mounts', filters: [
                    { field: 'is_mount', operator: 'eq', value: 'true' }
                ]},
                { label: 'Deadly Mobs', filters: [
                    { field: 'difficulty_tier', operator: 'eq', value: 'deadly' }
                ]},
            ]
        };

        function renderQuery(container) {
            const allAreaIds = Object.keys(analysisData).sort((a, b) => {
                return analysisData[a].summary.name.localeCompare(analysisData[b].summary.name);
            });

            const activeAreaFilter = queryAreaFilter.size > 0;
            const areaFilterText = activeAreaFilter
                ? `${queryAreaFilter.size} of ${allAreaIds.length} areas`
                : `All ${allAreaIds.length} areas`;

            container.innerHTML = `
                <h2>Query</h2>

                <div class="query-container">
                    <div class="query-type-selector">
                        <button class="query-type-btn ${queryType === 'objects' ? 'active' : ''}"
                                onclick="setQueryType('objects')">Objects</button>
                        <button class="query-type-btn ${queryType === 'mobs' ? 'active' : ''}"
                                onclick="setQueryType('mobs')">Mobs</button>
                    </div>

                    <div class="preset-queries">
                        ${(PRESET_QUERIES[queryType] || []).map(preset => `
                            <button class="preset-btn" onclick="applyPreset(${JSON.stringify(preset.filters).replace(/"/g, '&quot;')})">
                                ${preset.label}
                            </button>
                        `).join('')}
                    </div>

                    <div class="filter-builder">
                        <div id="filter-rows">
                            ${queryFilters.length === 0
                                ? '<p style="color: #888; margin: 0;">No filters. Click "Add Filter" to start.</p>'
                                : queryFilters.map((filter, idx) => renderFilterRow(idx, filter)).join('')}
                        </div>
                        <div class="filter-actions">
                            <button onclick="addFilter()">+ Add Filter</button>
                            <button onclick="clearFilters()">Clear All</button>
                            <button class="run-query" onclick="runQuery()">Run Query</button>
                            <button class="area-filter-toggle ${activeAreaFilter ? 'active' : ''}"
                                    onclick="toggleQueryAreaFilter()">
                                Areas: ${areaFilterText}
                            </button>
                        </div>

                        <div id="query-area-filter" class="query-area-filter area-filter">
                            <div class="area-filter-header">
                                <div class="area-filter-actions">
                                    <button onclick="querySelectAllAreas()">Select All</button>
                                    <button onclick="queryDeselectAllAreas()">Deselect All</button>
                                </div>
                            </div>
                            <div class="area-filter-grid">
                                ${allAreaIds.map(areaId => {
                                    const name = analysisData[areaId].summary.name;
                                    const isChecked = !activeAreaFilter || queryAreaFilter.has(areaId);
                                    return `
                                        <div class="area-filter-item ${isChecked ? '' : 'excluded'}">
                                            <input type="checkbox" id="qfilter-${areaId}"
                                                   ${isChecked ? 'checked' : ''}
                                                   onchange="toggleQueryArea('${areaId}', this.checked)">
                                            <label for="qfilter-${areaId}" title="${name}">${name}</label>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <div id="query-results">
                        ${renderQueryResults()}
                    </div>
                </div>
            `;
        }

        function renderFilterRow(index, filter) {
            const fields = QUERY_FIELDS[queryType] || [];
            const fieldDef = fields.find(f => f.id === filter.field) || fields[0];
            const operators = QUERY_OPERATORS[fieldDef?.type || 'text'];

            return `
                <div class="filter-row" data-index="${index}">
                    <select class="filter-field" onchange="updateFilterField(${index}, this.value)">
                        ${fields.map(f => `
                            <option value="${f.id}" ${f.id === filter.field ? 'selected' : ''}>${f.label}</option>
                        `).join('')}
                    </select>
                    <select class="filter-operator" onchange="updateFilterOperator(${index}, this.value)">
                        ${operators.map(op => `
                            <option value="${op.id}" ${op.id === filter.operator ? 'selected' : ''}>${op.label}</option>
                        `).join('')}
                    </select>
                    ${renderFilterValueInput(index, filter, fieldDef)}
                    <button class="filter-remove" onclick="removeFilter(${index})">√ó</button>
                </div>
            `;
        }

        function renderFilterValueInput(index, filter, fieldDef) {
            if (!fieldDef) return '<input class="filter-value" type="text">';

            if (fieldDef.type === 'select') {
                return `
                    <select class="filter-value" onchange="updateFilterValue(${index}, this.value)">
                        ${fieldDef.options.map(opt => `
                            <option value="${opt}" ${opt === filter.value ? 'selected' : ''}>${opt}</option>
                        `).join('')}
                    </select>
                `;
            } else if (fieldDef.type === 'boolean') {
                return `
                    <select class="filter-value" onchange="updateFilterValue(${index}, this.value)">
                        <option value="true" ${filter.value === 'true' ? 'selected' : ''}>Yes</option>
                        <option value="false" ${filter.value === 'false' ? 'selected' : ''}>No</option>
                    </select>
                `;
            } else if (fieldDef.type === 'number') {
                return `<input class="filter-value" type="number" value="${filter.value || ''}"
                         onchange="updateFilterValue(${index}, this.value)">`;
            } else {
                return `<input class="filter-value" type="text" value="${filter.value || ''}"
                         onchange="updateFilterValue(${index}, this.value)">`;
            }
        }

        function renderQueryResults() {
            if (queryResults.length === 0) {
                if (queryHasRun) {
                    return '<p style="color: #d3a47e;">No results found. Try adjusting your filters.</p>';
                }
                return '<p style="color: #888;">Run a query to see results.</p>';
            }

            const uniqueAreas = new Set(queryResults.map(r => r.area_id));

            if (queryType === 'objects') {
                // Check if we're showing weapons to add weapon-specific columns
                const hasWeapons = queryResults.some(obj => obj.item_type === 'weapon');
                const hasArmor = queryResults.some(obj => obj.item_type === 'armor');

                return `
                    <div class="query-results-header">
                        <span class="query-results-count">Found ${queryResults.length} objects across ${uniqueAreas.size} areas</span>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Area</th>
                                <th>VNUM</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Power</th>
                                ${hasWeapons ? '<th>Damage</th><th>Wpn Type</th>' : ''}
                                ${hasArmor ? '<th>AC</th>' : ''}
                                <th>Wear</th>
                                <th>Stats</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${queryResults.slice(0, 200).map(obj => `
                                <tr>
                                    <td><a href="analysis.html?area=${obj.area_id}">${obj.area_name}</a></td>
                                    <td>${obj.vnum}</td>
                                    <td>${obj.name}</td>
                                    <td>${obj.item_type}</td>
                                    <td>
                                        <span class="tier-badge tier-${obj.power_tier}">${obj.power_tier}</span>
                                        ${obj.power_score.toFixed(0)}
                                    </td>
                                    ${hasWeapons ? `
                                        <td>${obj.weapon ? `${obj.weapon.damage_min}-${obj.weapon.damage_max}` : '-'}</td>
                                        <td>${formatWeaponType(obj)}</td>
                                    ` : ''}
                                    ${hasArmor ? `
                                        <td>${obj.armor ? obj.armor.ac : '-'}</td>
                                    ` : ''}
                                    <td>${obj.wear_location || '-'}</td>
                                    <td>${formatStats(obj.stats_summary)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${queryResults.length > 200 ? `<p style="color: #888;">Showing first 200 of ${queryResults.length} results.</p>` : ''}
                `;
            } else {
                return `
                    <div class="query-results-header">
                        <span class="query-results-count">Found ${queryResults.length} mobs across ${uniqueAreas.size} areas</span>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Area</th>
                                <th>VNUM</th>
                                <th>Name</th>
                                <th>Level</th>
                                <th>Align</th>
                                <th>Difficulty</th>
                                <th>HP</th>
                                <th>Flags</th>
                                <th>Spawns</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${queryResults.slice(0, 200).map(mob => `
                                <tr>
                                    <td><a href="analysis.html?area=${mob.area_id}">${mob.area_name}</a></td>
                                    <td>${mob.vnum}</td>
                                    <td>${mob.name}${formatMobBadges(mob)}</td>
                                    <td>${mob.level}</td>
                                    <td style="color: ${mob.alignment > 350 ? '#7ed3a4' : mob.alignment < -350 ? '#d37e7e' : '#888'}">${mob.alignment}</td>
                                    <td>
                                        <span class="tier-badge tier-${mob.difficulty_tier}">${mob.difficulty_tier}</span>
                                    </td>
                                    <td>${mob.avg_hp.toLocaleString()}</td>
                                    <td>${formatMobFlags(mob)}</td>
                                    <td>${mob.spawn_count}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${queryResults.length > 200 ? `<p style="color: #888;">Showing first 200 of ${queryResults.length} results.</p>` : ''}
                `;
            }
        }

        function setQueryType(type) {
            queryType = type;
            queryFilters = [];
            queryResults = [];
            queryHasRun = false;
            renderContent();
        }

        function addFilter() {
            const fields = QUERY_FIELDS[queryType] || [];
            const firstField = fields[0];
            const operators = QUERY_OPERATORS[firstField?.type || 'text'];

            queryFilters.push({
                field: firstField?.id || '',
                operator: operators[0]?.id || 'eq',
                value: firstField?.type === 'select' ? (firstField.options[0] || '') :
                       firstField?.type === 'boolean' ? 'true' : ''
            });
            renderContent();
        }

        function removeFilter(index) {
            queryFilters.splice(index, 1);
            renderContent();
        }

        function clearFilters() {
            queryFilters = [];
            queryResults = [];
            queryHasRun = false;
            renderContent();
        }

        function updateFilterField(index, fieldId) {
            const fields = QUERY_FIELDS[queryType] || [];
            const fieldDef = fields.find(f => f.id === fieldId);
            const operators = QUERY_OPERATORS[fieldDef?.type || 'text'];

            queryFilters[index].field = fieldId;
            queryFilters[index].operator = operators[0]?.id || 'eq';
            queryFilters[index].value = fieldDef?.type === 'select' ? (fieldDef.options[0] || '') :
                                        fieldDef?.type === 'boolean' ? 'true' : '';
            renderContent();
        }

        function updateFilterOperator(index, operator) {
            queryFilters[index].operator = operator;
        }

        function updateFilterValue(index, value) {
            queryFilters[index].value = value;
        }

        function applyPreset(filters) {
            queryFilters = JSON.parse(JSON.stringify(filters));
            runQuery();
        }

        function runQuery() {
            queryResults = [];
            queryHasRun = true;

            const activeAreaFilter = queryAreaFilter.size > 0;
            const areasToSearch = activeAreaFilter
                ? Array.from(queryAreaFilter).filter(id => analysisData[id])
                : Object.keys(analysisData);

            for (const areaId of areasToSearch) {
                const areaData = analysisData[areaId];
                const areaName = areaData.summary.name;

                const entities = queryType === 'objects'
                    ? Object.values(areaData.objects || {})
                    : Object.values(areaData.mobs || {});

                for (const entity of entities) {
                    if (matchesFilters(entity, queryFilters)) {
                        queryResults.push({
                            ...entity,
                            area_id: areaId,
                            area_name: areaName
                        });
                    }
                }
            }

            // Sort results
            if (queryType === 'objects') {
                queryResults.sort((a, b) => b.power_score - a.power_score);
            } else {
                queryResults.sort((a, b) => b.difficulty_score - a.difficulty_score);
            }

            renderContent();
        }

        function getNestedValue(obj, path) {
            // Handle nested paths like "weapon.weapon_type"
            const parts = path.split('.');
            let value = obj;
            for (const part of parts) {
                if (value == null) return undefined;
                value = value[part];
            }
            return value;
        }

        function matchesFilters(entity, filters) {
            if (filters.length === 0) return true;

            for (const filter of filters) {
                const value = getNestedValue(entity, filter.field);
                const target = filter.value;

                let matches = false;
                switch (filter.operator) {
                    case 'eq':
                        if (typeof value === 'boolean') {
                            matches = value === (target === 'true');
                        } else if (typeof value === 'number') {
                            matches = value === parseFloat(target);
                        } else {
                            matches = String(value).toLowerCase() === String(target).toLowerCase();
                        }
                        break;
                    case 'neq':
                        if (typeof value === 'number') {
                            matches = value !== parseFloat(target);
                        } else {
                            matches = String(value).toLowerCase() !== String(target).toLowerCase();
                        }
                        break;
                    case 'contains':
                        matches = String(value).toLowerCase().includes(String(target).toLowerCase());
                        break;
                    case 'starts':
                        matches = String(value).toLowerCase().startsWith(String(target).toLowerCase());
                        break;
                    case 'gt':
                        matches = parseFloat(value) > parseFloat(target);
                        break;
                    case 'gte':
                        matches = parseFloat(value) >= parseFloat(target);
                        break;
                    case 'lt':
                        matches = parseFloat(value) < parseFloat(target);
                        break;
                    case 'lte':
                        matches = parseFloat(value) <= parseFloat(target);
                        break;
                }

                if (!matches) return false;
            }
            return true;
        }

        function toggleQueryAreaFilter() {
            const panel = document.getElementById('query-area-filter');
            panel.classList.toggle('visible');
        }

        function toggleQueryArea(areaId, isChecked) {
            if (queryAreaFilter.size === 0 && !isChecked) {
                // First time filtering - start with all selected except unchecked
                Object.keys(analysisData).forEach(id => {
                    if (id !== areaId) queryAreaFilter.add(id);
                });
            } else {
                if (isChecked) {
                    queryAreaFilter.add(areaId);
                } else {
                    queryAreaFilter.delete(areaId);
                }
            }
            renderContent();
        }

        function querySelectAllAreas() {
            queryAreaFilter.clear();
            renderContent();
        }

        function queryDeselectAllAreas() {
            queryAreaFilter.clear();
            queryAreaFilter.add('__none__');
            renderContent();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
