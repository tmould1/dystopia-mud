---
AWSTemplateFormatVersion: 2010-09-09
Description: >-
  CloudFormation for Dystopia MUD server with CI/CD via GitHub Actions and CodeDeploy.
  Supports multiple game instances (e.g., main + 5e) on separate ports with shared infrastructure.
  Includes EFS for persistent game data and SSM Parameter Store for configuration.
  **WARNING** This template creates EC2, EFS, VPC and related resources. You will be billed for the AWS resources used.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "VPC Configuration"
        Parameters:
          - VpcCIDR
          - PublicSubnet1CIDR
          - PublicSubnet2CIDR
          - PrivateSubnet1CIDR
          - PrivateSubnet2CIDR
      - Label:
          default: "Server Configuration"
        Parameters:
          - InstanceType
          - KeyName
          - SSHLocation
          - GamePortMain
          - GamePort5e
      - Label:
          default: "GitHub Configuration"
        Parameters:
          - GithubRepoName

Parameters:
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: must be the name of an existing EC2 KeyPair.

  InstanceType:
    Description: EC2 instance type for the MUD server
    Type: String
    Default: t3.small
    AllowedValues:
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t3.nano
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
    ConstraintDescription: must be a valid EC2 instance type.

  SSHLocation:
    Description: The IP address range that can be used to SSH to the EC2 instance
    Type: String
    MinLength: 9
    MaxLength: 18
    Default: 0.0.0.0/0
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.

  GamePortMain:
    Description: The port the main MUD server instance listens on
    Type: Number
    Default: 8888
    MinValue: 1024
    MaxValue: 65535

  GamePort5e:
    Description: The port the 5e MUD server instance listens on
    Type: Number
    Default: 8889
    MinValue: 1024
    MaxValue: 65535

  LatestAmiId:
    Description: Latest Amazon Linux 2023 AMI
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64

  VpcCIDR:
    Description: IP range (CIDR notation) for this VPC
    Type: String
    Default: 10.192.0.0/16

  PublicSubnet1CIDR:
    Description: IP range for the public subnet in the first Availability Zone
    Type: String
    Default: 10.192.10.0/24

  PublicSubnet2CIDR:
    Description: IP range for the public subnet in the second Availability Zone
    Type: String
    Default: 10.192.11.0/24

  PrivateSubnet1CIDR:
    Description: IP range for the private subnet in the first Availability Zone
    Type: String
    Default: 10.192.20.0/24

  PrivateSubnet2CIDR:
    Description: IP range for the private subnet in the second Availability Zone
    Type: String
    Default: 10.192.21.0/24

  GithubRepoName:
    Description: GitHub repository name (e.g., owner/repo-name)
    Type: String

Resources:
  #============================================================================
  # VPC and Networking
  #============================================================================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: MudderVPC

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: MudderIGW

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: !Ref PublicSubnet1CIDR
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Public Subnet (AZ1)

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs ""]
      CidrBlock: !Ref PublicSubnet2CIDR
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Public Subnet (AZ2)

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: !Ref PrivateSubnet1CIDR
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: Private Subnet (AZ1)

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs ""]
      CidrBlock: !Ref PrivateSubnet2CIDR
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: Private Subnet (AZ2)

  NatGateway1EIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc

  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway1EIP.AllocationId
      SubnetId: !Ref PublicSubnet1

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: Public Routes

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: Private Routes (AZ1)

  DefaultPrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet1

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: Private Routes (AZ2)

  DefaultPrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      SubnetId: !Ref PrivateSubnet2

  #============================================================================
  # Security Groups
  #============================================================================
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for MUD server
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !Ref GamePortMain
          ToPort: !Ref GamePortMain
          CidrIp: 0.0.0.0/0
          Description: MUD main game port
        - IpProtocol: tcp
          FromPort: !Ref GamePort5e
          ToPort: !Ref GamePort5e
          CidrIp: 0.0.0.0/0
          Description: MUD 5e game port
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref SSHLocation
          Description: SSH access
      Tags:
        - Key: Name
          Value: MudderInstanceSG

  EFSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for EFS mount targets
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          SourceSecurityGroupId: !Ref InstanceSecurityGroup
          Description: NFS from EC2 instances
      Tags:
        - Key: Name
          Value: MudderEFSSG

  #============================================================================
  # EFS (Elastic File System) for Persistent Game Data
  #============================================================================
  GameDataFileSystem:
    Type: AWS::EFS::FileSystem
    Properties:
      Encrypted: true
      PerformanceMode: generalPurpose
      ThroughputMode: bursting
      BackupPolicy:
        Status: ENABLED
      FileSystemTags:
        - Key: Name
          Value: MudderGameData

  EFSMountTarget1:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref GameDataFileSystem
      SubnetId: !Ref PublicSubnet1
      SecurityGroups:
        - !Ref EFSSecurityGroup

  EFSMountTarget2:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref GameDataFileSystem
      SubnetId: !Ref PublicSubnet2
      SecurityGroups:
        - !Ref EFSSecurityGroup

  #============================================================================
  # SSM Parameter Store (Configuration)
  #============================================================================
  SSMDeploymentBucket:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /mudder/deployment-bucket
      Type: String
      Value: !Ref WebappDeploymentBucket
      Description: S3 bucket for deployment artifacts

  SSMGamePortMain:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /mudder/main/game-port
      Type: String
      Value: !Ref GamePortMain
      Description: Main MUD server port

  SSMGamePort5e:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /mudder/5e/game-port
      Type: String
      Value: !Ref GamePort5e
      Description: 5e MUD server port

  SSMEFSFileSystemId:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /mudder/efs-filesystem-id
      Type: String
      Value: !Ref GameDataFileSystem
      Description: EFS filesystem ID for game data

  SSMCodeDeployApp:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /mudder/codedeploy-application
      Type: String
      Value: !Ref WebappApplication
      Description: CodeDeploy application name

  SSMCodeDeployGroupMain:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /mudder/main/codedeploy-deployment-group
      Type: String
      Value: !Ref WebappDeploymentGroupMain
      Description: CodeDeploy deployment group for main instance

  SSMCodeDeployGroup5e:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /mudder/5e/codedeploy-deployment-group
      Type: String
      Value: !Ref WebappDeploymentGroup5e
      Description: CodeDeploy deployment group for 5e instance

  SSMAWSRegion:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /mudder/aws-region
      Type: String
      Value: !Ref AWS::Region
      Description: AWS region for the deployment

  #============================================================================
  # IAM Roles and Policies
  #============================================================================
  WebappRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: MudderEC2Role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/AmazonElasticFileSystemClientReadWriteAccess
      Policies:
        - PolicyName: MudderS3Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource: !Sub arn:${AWS::Partition}:s3:::${WebappDeploymentBucket}/*
        - PolicyName: MudderSSMParameterAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                  - ssm:GetParametersByPath
                Resource: !Sub arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/mudder/*

  WebappInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref WebappRole

  GitHubIAMRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: MudderGitHubActionsRole
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Action: sts:AssumeRoleWithWebIdentity
            Principal:
              Federated: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:oidc-provider/token.actions.githubusercontent.com
            Condition:
              StringLike:
                token.actions.githubusercontent.com:sub: !Sub repo:${GithubRepoName}:*
      MaxSessionDuration: 3600
      Description: GitHub Actions role for MUD deployments
      Policies:
        - PolicyName: MudderGitHubActionsPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - codedeploy:Get*
                  - codedeploy:Batch*
                  - codedeploy:CreateDeployment
                  - codedeploy:RegisterApplicationRevision
                  - codedeploy:List*
                Resource:
                  - !Sub arn:${AWS::Partition}:codedeploy:${AWS::Region}:${AWS::AccountId}:*
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                Resource: !Sub arn:${AWS::Partition}:s3:::${WebappDeploymentBucket}/*
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                Resource: !Sub arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/mudder/*

  CodeDeployRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: MudderCodeDeployRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: codedeploy.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole

  #============================================================================
  # S3 Bucket for Deployment Artifacts
  #============================================================================
  WebappDeploymentBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: Name
          Value: MudderDeploymentBucket

  #============================================================================
  # CodeDeploy Application and Deployment Groups
  #============================================================================
  WebappApplication:
    Type: AWS::CodeDeploy::Application
    Properties:
      ApplicationName: MudderApplication
      ComputePlatform: Server

  WebappDeploymentGroupMain:
    Type: AWS::CodeDeploy::DeploymentGroup
    Properties:
      ApplicationName: !Ref WebappApplication
      DeploymentGroupName: MudderDeploymentGroup-main
      ServiceRoleArn: !GetAtt CodeDeployRole.Arn
      DeploymentConfigName: CodeDeployDefault.OneAtATime
      Ec2TagFilters:
        - Key: Application
          Value: MudderServer
          Type: KEY_AND_VALUE
      AutoRollbackConfiguration:
        Enabled: true
        Events:
          - DEPLOYMENT_FAILURE
          - DEPLOYMENT_STOP_ON_REQUEST

  WebappDeploymentGroup5e:
    Type: AWS::CodeDeploy::DeploymentGroup
    Properties:
      ApplicationName: !Ref WebappApplication
      DeploymentGroupName: MudderDeploymentGroup-5e
      ServiceRoleArn: !GetAtt CodeDeployRole.Arn
      DeploymentConfigName: CodeDeployDefault.OneAtATime
      Ec2TagFilters:
        - Key: Application
          Value: MudderServer
          Type: KEY_AND_VALUE
      AutoRollbackConfiguration:
        Enabled: true
        Events:
          - DEPLOYMENT_FAILURE
          - DEPLOYMENT_STOP_ON_REQUEST

  #============================================================================
  # EC2 Instance
  #============================================================================
  EC2Instance:
    Type: AWS::EC2::Instance
    DependsOn:
      - EFSMountTarget1
    Properties:
      InstanceType: !Ref InstanceType
      SubnetId: !Ref PublicSubnet1
      SecurityGroupIds:
        - !Ref InstanceSecurityGroup
      KeyName: !Ref KeyName
      ImageId: !Ref LatestAmiId
      IamInstanceProfile: !Ref WebappInstanceProfile
      Tags:
        - Key: Name
          Value: MudderServer
        - Key: Application
          Value: MudderServer
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -ex

          # Log all output
          exec > >(tee /var/log/user-data.log) 2>&1

          echo "Starting MUD server setup..."

          # Update system and install dependencies (AL2023 uses dnf)
          dnf update -y
          dnf install -y ruby wget amazon-efs-utils jq nmap-ncat libxcrypt-compat

          # Install CodeDeploy agent
          cd /tmp
          wget https://aws-codedeploy-${AWS::Region}.s3.${AWS::Region}.amazonaws.com/latest/install
          chmod +x ./install
          ./install auto
          systemctl enable codedeploy-agent
          systemctl start codedeploy-agent

          # Create mudder user and directories
          useradd -r -s /sbin/nologin mudder || true
          mkdir -p /usr/local/mudder/efs
          mkdir -p /usr/local/mudder/main/bin
          mkdir -p /usr/local/mudder/5e/bin

          # Mount EFS for persistent game data
          EFS_ID="${GameDataFileSystem}"
          echo "${!EFS_ID}:/ /usr/local/mudder/efs efs _netdev,tls,iam 0 0" >> /etc/fstab
          mount -a

          # Create persistent directories on EFS for each instance
          for INST in main 5e; do
            mkdir -p /usr/local/mudder/efs/$INST/db/areas
            mkdir -p /usr/local/mudder/efs/$INST/db/game
            mkdir -p /usr/local/mudder/efs/$INST/db/players/backup
            mkdir -p /usr/local/mudder/efs/$INST/log
            mkdir -p /usr/local/mudder/efs/$INST/doc
            mkdir -p /usr/local/mudder/efs/$INST/run
            mkdir -p /usr/local/mudder/efs/$INST/txt

            # Symlink gamedata to EFS subdirectory
            ln -sf /usr/local/mudder/efs/$INST /usr/local/mudder/$INST/gamedata
          done

          # Set ownership
          chown -R mudder:mudder /usr/local/mudder

          # Create systemd service file for main instance
          cat > /etc/systemd/system/mudder-main.service << 'EOF'
          [Unit]
          Description=Dystopia MUD Server (main)
          After=syslog.target network.target remote-fs.target
          Requires=remote-fs.target

          [Service]
          Type=simple
          User=mudder
          Group=mudder
          WorkingDirectory=/usr/local/mudder/main/gamedata
          ExecStart=/usr/local/mudder/main/gamedata/dystopia ${GamePortMain}
          ExecStop=/bin/kill -TERM $MAINPID
          Restart=on-failure
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          EOF

          # Create systemd service file for 5e instance
          cat > /etc/systemd/system/mudder-5e.service << 'EOF'
          [Unit]
          Description=Dystopia MUD Server (5e)
          After=syslog.target network.target remote-fs.target
          Requires=remote-fs.target

          [Service]
          Type=simple
          User=mudder
          Group=mudder
          WorkingDirectory=/usr/local/mudder/5e/gamedata
          ExecStart=/usr/local/mudder/5e/gamedata/dystopia ${GamePort5e}
          ExecStop=/bin/kill -TERM $MAINPID
          Restart=on-failure
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          EOF

          systemctl daemon-reload
          systemctl enable mudder-main.service
          systemctl enable mudder-5e.service

          echo "MUD server setup complete. Waiting for CodeDeploy to deploy binaries."

Outputs:
  DeploymentBucket:
    Description: S3 bucket for deployment artifacts
    Value: !Ref WebappDeploymentBucket
    Export:
      Name: MudderDeploymentBucket

  ApplicationName:
    Description: CodeDeploy application name
    Value: !Ref WebappApplication

  DeploymentGroupMain:
    Description: CodeDeploy deployment group (main instance)
    Value: !Ref WebappDeploymentGroupMain

  DeploymentGroup5e:
    Description: CodeDeploy deployment group (5e instance)
    Value: !Ref WebappDeploymentGroup5e

  GitHubIAMRoleArn:
    Description: IAM role ARN for GitHub Actions (add as repository secret AWS_OIDC_ROLE_ARN)
    Value: !GetAtt GitHubIAMRole.Arn
    Export:
      Name: MudderGitHubRoleArn

  EFSFileSystemId:
    Description: EFS filesystem ID for game data
    Value: !Ref GameDataFileSystem
    Export:
      Name: MudderEFSFileSystemId

  InstanceId:
    Description: EC2 instance ID
    Value: !Ref EC2Instance

  PublicIP:
    Description: Public IP address of the MUD server
    Value: !GetAtt EC2Instance.PublicIp

  PublicDNS:
    Description: Public DNS name of the MUD server
    Value: !GetAtt EC2Instance.PublicDnsName

  MainGameConnectionString:
    Description: How to connect to the main MUD instance
    Value: !Sub "telnet ${EC2Instance.PublicIp} ${GamePortMain}"

  FiveEGameConnectionString:
    Description: How to connect to the 5e MUD instance
    Value: !Sub "telnet ${EC2Instance.PublicIp} ${GamePort5e}"
